generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int     @id @default(autoincrement())
  email       String  @unique
  password    String  @db.VarChar(255)
  nickName    String
  username    String  @unique
  description String?
  avatarUrl   String? @db.VarChar(512)
  isVerified  Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt()

  sentRequests          Friendship[]      @relation("sender")
  receivedRequests      Friendship[]      @relation("receiver")
  blockedUsers          Block[]           @relation("blocker")
  blockedByUsers        Block[]           @relation("blocked")

  refreshToken RefreshToken[]
}

model Friendship {
  id      Int       @id      @default(autoincrement())
  senderId      Int           
  receiverId    Int
  status        FriendshipStatus    @default(PENDING)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt()

  sender    User    @relation("sender", fields: [senderId], references: [id])
  receiver  User    @relation("receiver", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model Block {
  id              Int       @id     @default(autoincrement())
  blockerId       Int       
  blockedId       Int
  
  blocker         User      @relation("blocker", fields: [blockerId], references: [id])
  blocked         User      @relation("blocked", fields: [blockedId], references: [id])

  createdAt       DateTime  @default(now())

  @@unique([blockerId, blockedId])
  @@index([blockedId])
  @@index([blockerId])
}

model RefreshToken {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  familyId          String    @default(uuid())              @db.Uuid 
  tokenHash         String    @db.Text
  previousTokenHash String?   @db.Text
  usedAt            DateTime?
  expiresAt         DateTime
  revoked           Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt()

  @@index([userId])
  @@index([familyId])
  @@index([userId, revoked]) 
}

model AppKeys {
  key      String  @unique
  adminKey Boolean @default(false)
}

model Devices {
  id        Int    @id @default(autoincrement())
  deviceKey String
}
